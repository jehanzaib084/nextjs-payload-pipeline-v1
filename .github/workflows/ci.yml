name: Next.js + Payload CMS CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Auto-fix linting and formatting issues
        run: |
          echo "ğŸ”§ Auto-fixing ESLint issues..."
          pnpm lint:fix || echo "âš ï¸ Some ESLint issues couldn't be auto-fixed"

          echo "ğŸ¨ Auto-formatting code with Prettier..."
          pnpm format || echo "âš ï¸ Some formatting issues couldn't be auto-fixed"

      - name: Run ESLint (final check)
        run: |
          echo "ğŸ” Running final ESLint check..."
          if ! pnpm lint; then
            echo ""
            echo "âŒ ESLint found issues that need manual attention:"
            echo ""
            echo "ğŸ’¡ To fix locally:"
            echo "   pnpm lint:fix"
            echo ""
            echo "ğŸ“‹ Common issues and solutions:"
            echo "   â€¢ Unused variables: Remove them or prefix with underscore (_)"
            echo "   â€¢ Missing dependencies: Add missing imports"
            echo "   â€¢ TypeScript errors: Fix type annotations"
            echo ""
            exit 1
          fi

      - name: Run Prettier check (final check)
        run: |
          echo "ğŸ¨ Checking code formatting..."
          if ! pnpm format:check; then
            echo ""
            echo "âŒ Code formatting issues found!"
            echo ""
            echo "ğŸ’¡ To fix locally:"
            echo "   pnpm format"
            echo ""
            echo "This will automatically format all your files."
            echo ""
            exit 1
          fi

      - name: TypeScript type checking
        run: |
          echo "ğŸ” Checking TypeScript types..."
          if ! pnpm type-check; then
            echo ""
            echo "âŒ TypeScript type errors found!"
            echo ""
            echo "ğŸ’¡ Common solutions:"
            echo "   â€¢ Check import/export statements"
            echo "   â€¢ Verify type annotations match usage"
            echo "   â€¢ Run 'pnpm generate:types' for Payload CMS types"
            echo "   â€¢ Ensure all dependencies are installed"
            echo ""
            echo "ğŸ”§ To check locally:"
            echo "   pnpm type-check"
            echo ""
            exit 1
          fi

      - name: Check for Next.js App Router best practices
        run: |
          echo "ğŸ” Checking for Next.js App Router patterns..."

          # Check for proper use of 'use server' directive
          server_actions=$(find src -name "*.ts" -o -name "*.tsx" | xargs grep -l "use server" | wc -l)
          echo "âœ… Found $server_actions files with server actions"

          # Check for middleware.ts existence
          if [ -f "src/middleware.ts" ] || [ -f "middleware.ts" ]; then
            echo "âœ… Middleware file found"
          else
            echo "â„¹ï¸ No middleware file detected (optional)"
          fi

          # Check for proper app directory structure
          if [ -d "src/app" ]; then
            echo "âœ… App Router structure detected"
          else
            echo "âŒ App Router structure not found"
            exit 1
          fi

          # Check for layout.tsx files
          layouts=$(find src/app -name "layout.tsx" | wc -l)
          echo "âœ… Found $layouts layout files"

          # Check for proper loading.tsx and error.tsx files
          loading_files=$(find src/app -name "loading.tsx" | wc -l)
          error_files=$(find src/app -name "error.tsx" | wc -l)
          echo "â„¹ï¸ Found $loading_files loading.tsx and $error_files error.tsx files"

  payload-validation:
    name: Payload CMS Validation
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate Payload config
        run: |
          echo "ğŸš€ Validating Payload CMS configuration..."
          if ! pnpm payload generate:types; then
            echo ""
            echo "âŒ Payload CMS configuration error!"
            echo ""
            echo "ğŸ’¡ Common Payload issues and solutions:"
            echo "   â€¢ Database connection: Check DATABASE_URI in .env"
            echo "   â€¢ Invalid collections: Check collections/*.ts files"
            echo "   â€¢ Missing dependencies: Run 'pnpm install'"
            echo "   â€¢ Config syntax: Check payload.config.ts syntax"
            echo ""
            echo "ğŸ”§ To debug locally:"
            echo "   pnpm payload generate:types"
            echo "   Check payload.config.ts for errors"
            echo ""
            exit 1
          fi
          echo "âœ… Payload types generated successfully"

      - name: Check Payload collections
        run: |
          echo "ğŸ“¦ Checking Payload collections..."
          collections=$(find src/collections -name "*.ts" | wc -l)
          echo "âœ… Found $collections collection files"

      - name: Validate environment variables
        run: |
          echo "ğŸ”§ Checking required environment variables..."
          if [ -f ".env.example" ]; then
            echo "âœ… .env.example found"
            cat .env.example | grep -E "^[A-Z_]+=" | while read line; do
              var_name=$(echo $line | cut -d'=' -f1)
              echo "ğŸ“ Required: $var_name"
            done
          fi

  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: [code-quality, payload-validation]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create test environment file
        run: |
          cp .env.example .env
          echo "DATABASE_URI=file:./test.db" >> .env
          echo "PAYLOAD_SECRET=test-secret-key" >> .env
          echo "NEXT_PUBLIC_SERVER_URL=http://localhost:3000" >> .env

      - name: Build project
        run: |
          echo "ğŸ—ï¸ Building Next.js project..."
          if ! pnpm build; then
            echo ""
            echo "âŒ Build failed!"
            echo ""
            echo "ğŸ’¡ Common build issues and solutions:"
            echo "   â€¢ TypeScript errors: Fix type issues"
            echo "   â€¢ Missing environment variables: Check .env file"
            echo "   â€¢ Import errors: Verify all imports exist"
            echo "   â€¢ Payload CMS config issues: Check payload.config.ts"
            echo ""
            echo "ğŸ”§ To debug locally:"
            echo "   pnpm build"
            echo "   pnpm type-check"
            echo "   pnpm generate:types"
            echo ""
            exit 1
          fi

      - name: Run tests
        run: pnpm test
        continue-on-error: true

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level moderate
        continue-on-error: true

  deploy-check:
    name: Deployment Ready Check
    runs-on: ubuntu-latest
    needs: [build-test, security-audit]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Production build
        run: pnpm build

      - name: Check build size
        run: |
          echo "ğŸ“Š Build size analysis:"
          du -sh .next/

      - name: Deployment readiness
        run: |
          echo "ğŸš€ Project is ready for deployment!"
          echo "âœ… All checks passed"
          echo "âœ… Build completed successfully"
          echo "âœ… Next.js App Router structure validated"
          echo "âœ… Payload CMS configuration verified"
